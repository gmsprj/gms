#!/bin/bash
#
# DBのテーブルを初期化する。
#
DBUSER="$FWU_DBUSER"
DBNAME="$FWU_DBNAME"

echo db-user:$DBUSER
echo db-name:$DBNAME

fwu-confirm "上記の DB を初期化します。テーブルは再構築されません。本当に実行しますか？"
if [ $? -ne 0 ]; then
    exit 0
fi

NOW=`date +%Y-%m-%d`

mysql -u $DBUSER -p $DBNAME <<EOF

-- テーブルのクリア

DELETE FROM configs;
ALTER TABLE configs AUTO_INCREMENT = 1;

DELETE FROM posts;
ALTER TABLE posts AUTO_INCREMENT = 1;

DELETE FROM threads;
ALTER TABLE threads AUTO_INCREMENT = 1;

DELETE FROM boards;
ALTER TABLE boards AUTO_INCREMENT = 1;

DELETE FROM users;
ALTER TABLE users AUTO_INCREMENT = 1;

DELETE FROM guilds;
ALTER TABLE guilds AUTO_INCREMENT = 1;


-- サイトの設定

INSERT INTO configs (site_name, site_desc) VALUES (
  'FWU（仮）',
  '労働者のユニオン・サイト'
);


-- Plaza 用の板、スレッド、ポストを作成

INSERT INTO boards (name, parent_name) VALUES ('ロビー', 'plaza');
SET @board_id = LAST_INSERT_ID();

INSERT INTO threads (name, board_id) VALUES ('雑談スレ', @board_id);
SET @thread_id = LAST_INSERT_ID();

INSERT INTO posts (name, content, thread_id) VALUES ('名無し', '雑談スレです。', @thread_id);


-- Guilds と板、スレッド、ポストを作成

-- 入門者ギルド

INSERT INTO guilds (name) VALUES ('入門者');
SET @guild_id = LAST_INSERT_ID();

INSERT INTO boards (name, parent_name, parent_id) VALUES ('入門者', 'guilds', @guild_id);
SET @board_id = LAST_INSERT_ID();

INSERT INTO threads (name, board_id) VALUES ('ギルド・雑談スレ', @board_id);
SET @thread_id = LAST_INSERT_ID();

INSERT INTO posts (name, content, thread_id) VALUES ('Name Not Found', 'ギルドの雑談スレです。', @thread_id);

-- Web制作管理ギルド

INSERT INTO guilds (name) VALUES ('Web制作管理');
SET @guild_id = LAST_INSERT_ID();

INSERT INTO boards (name, parent_name, parent_id) VALUES ('Web制作管理', 'guilds', @guild_id);
SET @board_id = LAST_INSERT_ID();

INSERT INTO threads (name, board_id) VALUES ('Web制作管理・雑談スレ', @board_id);
SET @thread_id = LAST_INSERT_ID();

INSERT INTO posts (name, content, thread_id) VALUES ('Name Not Found', 'ギルドの雑談スレです。', @thread_id);

EOF

